# ~/.tmux.conf - Modern tmux configuration for nvim users

# ============================================================================
# CORE SETTINGS
# ============================================================================

# Terminal & Colors
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ',xterm-256color:Tc:sitm=\E[3m'

# Clipboard & Passthrough (essential for Claude CLI, mosh, OSC 52)
set -g allow-passthrough on
set -g set-clipboard on
set -ag terminal-features ',xterm-256color:clipboard'
set -ga terminal-overrides ',xterm-256color:Ms=\E]52;c;%p2%s\007'

# Mouse support
set -g mouse on

# Indexing (start at 1, renumber on close)
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# History & Performance
set -g history-limit 50000
set -s escape-time 10
set -sg repeat-time 600
set -g focus-events on

# ============================================================================
# PREFIX & BASIC KEYBINDINGS
# ============================================================================

# Prefix: Alt+Space
unbind C-b
set -g prefix M-Space
bind M-Space send-prefix

# Config reload
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Edit config
bind e new-window -n 'tmux-config' 'nvim ~/.tmux.conf'

# Help
bind ':' command-prompt
bind '?' list-keys

# ============================================================================
# PANE MANAGEMENT
# ============================================================================

# Splits (keep current path)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Vim-aware pane switching (works with vim-tmux-navigator)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?)(diff)?$'"

bind -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# Copy-mode pane switching
bind -T copy-mode-vi 'C-h' select-pane -L
bind -T copy-mode-vi 'C-j' select-pane -D
bind -T copy-mode-vi 'C-k' select-pane -U
bind -T copy-mode-vi 'C-l' select-pane -R

# Resize panes (vim-style, repeatable)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Synchronize panes toggle
bind y setw synchronize-panes

# Clear screen and history
bind C-l send-keys 'clear' Enter \; clear-history

# ============================================================================
# WINDOW MANAGEMENT
# ============================================================================

# New window (keep current path)
bind w new-window -c "#{pane_current_path}"

# Alt+number for quick window switching
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Alt+h/l for prev/next window
bind -n M-h previous-window
bind -n M-l next-window

# Quick layouts (prefix + Alt+number)
bind M-1 select-layout even-horizontal
bind M-2 select-layout even-vertical
bind M-3 select-layout main-horizontal
bind M-4 select-layout main-vertical
bind M-5 select-layout tiled

# ============================================================================
# SESSION MANAGEMENT
# ============================================================================

# Alt+j/k for session switching
bind -n M-j switch-client -n
bind -n M-k switch-client -p

# New session
bind N new-session

# Don't exit tmux when closing a session
set -g detach-on-destroy off

# Nested session handling
bind t if-shell '[ "#{session_name}" = "inner" ]' \
    'send-keys C-Space' \
    'new-session -d -s inner; switch-client -t inner'

# ============================================================================
# COPY MODE (VI-STYLE)
# ============================================================================

setw -g mode-keys vi

bind Enter copy-mode
bind p paste-buffer

bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X cancel

# ============================================================================
# DEVELOPMENT LAYOUTS
# ============================================================================

# Project layout: main + side terminal
bind P split-window -h -p 30 -c "#{pane_current_path}" \; \
       split-window -v -p 70 -c "#{pane_current_path}" \; \
       select-pane -L

# Dev layout: editor + terminal + logs
bind D split-window -v -p 20 -c "#{pane_current_path}" \; \
       split-window -h -p 50 -c "#{pane_current_path}" \; \
       select-pane -U

# Named pane navigation (requires panes to be titled)
bind c run-shell 'tmux select-window -t :editor 2>/dev/null && tmux select-pane -t $(tmux list-panes -F "#{pane_index} #{pane_title}" | grep "claude$" | cut -d" " -f1) 2>/dev/null || tmux display-message "Claude pane not found"'
bind n run-shell 'tmux select-window -t :editor 2>/dev/null && tmux select-pane -t $(tmux list-panes -F "#{pane_index} #{pane_title}" | grep "nvim$" | cut -d" " -f1) 2>/dev/null || tmux display-message "Nvim pane not found"'
bind s run-shell 'tmux select-window -t :servers 2>/dev/null && tmux select-pane -t $(tmux list-panes -F "#{pane_index} #{pane_title}" | grep "server$" | cut -d" " -f1) 2>/dev/null || tmux display-message "Server pane not found"'
bind g run-shell 'tmux select-window -t :git 2>/dev/null && tmux select-pane -t $(tmux list-panes -F "#{pane_index} #{pane_title}" | grep "git$" | cut -d" " -f1) 2>/dev/null || tmux display-message "Git pane not found"'

# ============================================================================
# STATUS BAR (Gruvbox Dark Hard - Refined)
# ============================================================================

set -g status on
set -g status-position bottom
set -g status-interval 2
set -g status-justify left
set -g status-style "bg=#1d2021,fg=#ebdbb2"

# Left side: clean session indicator
set -g status-left-length 100
set -g status-left "#[bg=#fabd2f,fg=#1d2021,bold] 󰇘 #S #[bg=#3c3836,fg=#fabd2f]#[bg=#3c3836,fg=#a89984] #{session_windows} #[bg=#1d2021,fg=#3c3836] "

# Window list styling
set -g status-justify left
setw -g window-status-separator ""

# Inactive windows - subtle and elegant
setw -g window-status-format "#[fg=#504945]#[bg=#504945,fg=#a89984] #I#[fg=#665c54]:#[fg=#a89984]#W#{?window_zoomed_flag, 󰍉 ,}#[fg=#1d2021,bg=#1d2021]#[fg=#1d2021] "

# Active window - bold accent
setw -g window-status-current-format "#[fg=#fe8019]#[bg=#fe8019,fg=#1d2021,bold] #I#[fg=#1d2021]:#[fg=#1d2021,bold]#W#{?window_zoomed_flag, 󰍉 ,}#[fg=#fe8019,bg=#1d2021] "

# Right side: refined system info with icons
set -g status-right-length 150
set -g status-right "#[fg=#3c3836]#[bg=#3c3836,fg=#8ec07c]  #{cpu_percentage} #[fg=#504945]#[bg=#504945,fg=#fabd2f] 󰍛 #{ram_percentage} #[fg=#665c54]#[bg=#665c54,fg=#d3869b]  %a %d %b #[fg=#83a598]#[bg=#83a598,fg=#1d2021,bold]  %H:%M "

# Customize prefix highlight (when prefix is active)
set -g @prefix_highlight_fg '#1d2021'
set -g @prefix_highlight_bg '#b8bb26'
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr 'fg=#1d2021,bg=#fe8019,bold'
set -g @prefix_highlight_prefix_prompt 'PREFIX'
set -g @prefix_highlight_copy_prompt 'COPY'

# ============================================================================
# PANE & WINDOW APPEARANCE
# ============================================================================

set -g pane-border-style 'fg=#3c3836'
set -g pane-active-border-style 'fg=#fabd2f,bold'
set -g message-style 'bg=#fabd2f,fg=#1d2021,bold'
set -g message-command-style 'bg=#fe8019,fg=#1d2021,bold'

# Window titles
set -g set-titles on
set -g set-titles-string '#S:#I.#P #W'

# Activity monitoring (silent)
setw -g monitor-activity on
set -g visual-activity off
set -g visual-bell off

# Aggressive resize for multi-client
setw -g aggressive-resize on

# ============================================================================
# PLUGINS (TPM)
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'jaclu/tmux-power-zoom'
set -g @plugin 'alexwforsythe/tmux-which-key'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

# Plugin settings
set -g @override_copy_command '~/bin/osc52-copy'
set -g @resurrect-strategy-nvim 'session'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'
set -g @sessionx-bind 'o'

# Initialize TPM (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'

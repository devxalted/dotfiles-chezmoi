# ========================================
# Zinit Plugin Manager
# ========================================

# Set the directory we want to store zinit and plugins
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"

# Download zinit if it's not there yet
if [ ! -d "$ZINIT_HOME" ]; then
   mkdir -p "$(dirname $ZINIT_HOME)"
   git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi

# Source/Load zinit
source "${ZINIT_HOME}/zinit.zsh"

# ========================================
# Zinit Plugins
# ========================================

# Load important plugins first (no turbo mode)
zinit light zsh-users/zsh-autosuggestions
zinit light zdharma-continuum/fast-syntax-highlighting
zinit light zsh-users/zsh-completions

# Load plugins with turbo mode for faster startup
zinit ice wait lucid
zinit light zsh-users/zsh-history-substring-search

# NOTE: zsh-autocomplete disabled - causes conflicts with tmux
# zinit ice wait lucid
# zinit light marlonrichert/zsh-autocomplete

zinit ice wait lucid
zinit snippet OMZ::plugins/colored-man-pages/colored-man-pages.plugin.zsh

zinit ice wait lucid
zinit snippet OMZ::plugins/extract/extract.plugin.zsh

zinit ice wait lucid
zinit snippet OMZ::plugins/sudo/sudo.plugin.zsh

zinit ice wait lucid
zinit snippet OMZ::plugins/command-not-found/command-not-found.plugin.zsh

# ========================================
# Zsh Options
# ========================================

# History settings
HISTSIZE=10000
HISTFILE=~/.zsh_history
SAVEHIST=$HISTSIZE
HISTDUP=erase
setopt appendhistory
setopt sharehistory
setopt hist_ignore_space
setopt hist_ignore_all_dups
setopt hist_save_no_dups
setopt hist_ignore_dups
setopt hist_find_no_dups

# Directory navigation
setopt auto_cd
setopt auto_pushd
setopt pushd_ignore_dups
setopt pushdminus

# Completion settings
setopt always_to_end
setopt complete_in_word
setopt glob_dots
setopt menu_complete

# Other useful options
setopt interactive_comments
setopt long_list_jobs
setopt notify
setopt prompt_subst

# Disable beep
unsetopt beep
unsetopt list_beep

# ========================================
# Completion System
# ========================================

autoload -Uz compinit

# Load compinit with cache for faster startup
if [[ -n ${ZDOTDIR}/.zcompdump(#qN.mh+24) ]]; then
  compinit
else
  compinit -C
fi

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' menu select
zstyle ':completion:*' special-dirs true
zstyle ':completion:*' squeeze-slashes true
zstyle ':completion:*:*:*:*:descriptions' format '%F{green}-- %d --%f'
zstyle ':completion:*:*:*:*:corrections' format '%F{yellow}!- %d (errors: %e) -!%f'
zstyle ':completion:*:messages' format ' %F{purple} -- %d --%f'
zstyle ':completion:*:warnings' format ' %F{red}-- no matches found --%f'
zstyle ':completion:*:default' list-prompt '%S%M matches%s'
zstyle ':completion:*' group-name ''
zstyle ':completion:*' verbose yes

# Enable kubectl completion if kubectl is installed
command -v kubectl &> /dev/null && source <(kubectl completion zsh)

# ========================================
# Key Bindings
# ========================================

# Use emacs key bindings
bindkey -e

# History substring search (Up/Down arrows)
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down

# Ctrl+Left/Right for word navigation
bindkey '^[[1;5C' forward-word
bindkey '^[[1;5D' backward-word

# Delete key
bindkey '^[[3~' delete-char

# Home and End keys
bindkey '^[[H' beginning-of-line
bindkey '^[[F' end-of-line

# Ctrl+Backspace to delete word
bindkey '^H' backward-kill-word

# Ctrl+Delete to delete word forward
bindkey '^[[3;5~' kill-word

# Alt+Backspace to delete word
bindkey '^[^?' backward-kill-word

# Edit command line in $EDITOR with Ctrl+X Ctrl+E
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^X^E' edit-command-line

# ========================================
# Autosuggestions Configuration
# ========================================

# Configure autosuggestions
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=240'
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20

# Accept autosuggestions with Ctrl+Space
bindkey '^ ' autosuggest-accept

# ========================================
# Source Modular Configurations
# ========================================

# Source aliases
if [ -f ~/.zshrc.d/aliases.zsh ]; then
  source ~/.zshrc.d/aliases.zsh
fi

# Source functions
if [ -f ~/.zshrc.d/functions.zsh ]; then
  source ~/.zshrc.d/functions.zsh
fi

# ========================================
# Tool Initializations
# ========================================

# fnm (Fast Node Manager)
eval "$(fnm env --use-on-cd)"

# zoxide (smarter cd)
eval "$(zoxide init zsh)"

# Starship prompt
eval "$(starship init zsh)"

# ========================================
# PATH Configuration
# ========================================

{{- if eq .chezmoi.os "darwin" }}
# macOS: Homebrew paths
export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$HOME/.scripts:$HOME/.local/bin:$PATH"
{{- else }}
export PATH="$HOME/.scripts:$HOME/.local/bin:$PATH"
{{- end }}

# Default editor
export EDITOR="nvim"
export VISUAL="nvim"

# ========================================
# FZF Configuration (if installed)
# ========================================

if command -v fzf &> /dev/null; then
  # FZF default options
  export FZF_DEFAULT_OPTS="
    --height 40%
    --layout=reverse
    --border
    --inline-info
    --color=fg:#d0d0d0,bg:#121212,hl:#5f87af
    --color=fg+:#d0d0d0,bg+:#262626,hl+:#5fd7ff
    --color=info:#afaf87,prompt:#d7005f,pointer:#af5fff
    --color=marker:#87ff00,spinner:#af5fff,header:#87afaf
  "

  # Use fd for fzf if available
  if command -v fd &> /dev/null; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
  fi

  # Load fzf key bindings and completion if available
{{- if eq .chezmoi.os "darwin" }}
  # macOS: fzf installed via Homebrew
  if [ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]; then
    source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
  fi

  if [ -f /opt/homebrew/opt/fzf/shell/completion.zsh ]; then
    source /opt/homebrew/opt/fzf/shell/completion.zsh
  fi
{{- else }}
  # Linux: fzf from package manager
  if [ -f /usr/share/fzf/key-bindings.zsh ]; then
    source /usr/share/fzf/key-bindings.zsh
  fi

  if [ -f /usr/share/fzf/completion.zsh ]; then
    source /usr/share/fzf/completion.zsh
  fi
{{- end }}
fi

# ========================================
# Performance Monitoring (optional - uncomment to enable)
# ========================================

# Uncomment to measure shell startup time
# zmodload zsh/zprof
# Add 'zprof' at the end of this file to see profiling results

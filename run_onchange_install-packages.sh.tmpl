#!/bin/bash

set -e

echo "Installing packages..."

{{ if eq .chezmoi.os "darwin" -}}
# macOS - Xcode Command Line Tools + Homebrew
if ! xcode-select -p &> /dev/null; then
    echo "Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "Please complete the Xcode installation and re-run chezmoi apply"
    exit 0
fi

if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

brew bundle --no-lock --file=/dev/stdin <<EOF
# Modern CLI replacements
brew "eza"
brew "bat"
brew "fd"
brew "ripgrep"
brew "sd"
brew "bottom"
brew "btop"
brew "dust"
brew "duf"
brew "procs"
brew "zoxide"
brew "curlie"
brew "dog"

# Fuzzy finder & prompt
brew "fzf"
brew "starship"

# Dev tools
brew "fnm"
brew "bun"
brew "tmux"
brew "neovim"
brew "git"
brew "lazygit"
brew "lazydocker"
brew "delta"
brew "gh"
brew "just"
brew "direnv"
brew "tokei"

# Cloud/Platform CLIs
brew "supabase/tap/supabase"
brew "stripe/stripe-cli/stripe"
brew "railway"

# Utilities
brew "curl"
brew "wget"
brew "rsync"
brew "mosh"
brew "jq"
brew "yq"
brew "tree"
brew "htop"
brew "tldr"
brew "chezmoi"

# Extra dev tools
brew "hyperfine"
brew "glow"
brew "watchexec"
brew "xh"
brew "grex"
brew "bandwhich"
brew "ngrok"
EOF

# Vercel needs npm install
echo "Installing Vercel CLI..."
command -v vercel &> /dev/null || npm install -g vercel

{{ else if eq .chezmoi.os "linux" -}}
# Arch Linux - pacman
{{ if lookPath "pacman" -}}
sudo pacman -S --needed --noconfirm \
    eza \
    bat \
    fd \
    ripgrep \
    sd \
    bottom \
    btop \
    dust \
    duf \
    procs \
    zoxide \
    curlie \
    dog \
    fzf \
    starship \
    fnm \
    bun \
    tmux \
    neovim \
    git \
    lazygit \
    lazydocker \
    git-delta \
    github-cli \
    just \
    direnv \
    tokei \
    curl \
    wget \
    rsync \
    mosh \
    jq \
    yq \
    tree \
    htop \
    tldr \
    chezmoi \
    base-devel \
    hyperfine \
    glow \
    watchexec \
    xh \
    grex \
    bandwhich \
    ngrok

# AUR packages (via paru or yay)
if command -v paru &> /dev/null; then
    AUR_HELPER="paru"
elif command -v yay &> /dev/null; then
    AUR_HELPER="yay"
else
    echo "No AUR helper found, skipping AUR packages"
    AUR_HELPER=""
fi

if [ -n "$AUR_HELPER" ]; then
    $AUR_HELPER -S --needed --noconfirm \
        supabase-bin \
        stripe-cli-bin \
        vercel \
        railway-bin
fi

{{ end -}}
{{ end -}}

echo "Packages installed!"

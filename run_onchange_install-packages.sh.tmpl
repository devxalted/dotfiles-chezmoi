#!/bin/bash

set -e

echo "Installing packages..."

{{ if eq .chezmoi.os "darwin" -}}
# macOS - Xcode Command Line Tools + Homebrew
if ! xcode-select -p &> /dev/null; then
    echo "Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "Please complete the Xcode installation and re-run chezmoi apply"
    exit 0
fi

if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

brew bundle --file=/dev/stdin <<EOF
# Taps
tap "supabase/tap"
tap "stripe/stripe-cli"
tap "dopplerhq/cli"

# Modern CLI replacements
brew "eza"
brew "bat"
brew "fd"
brew "ripgrep"
brew "sd"
brew "btop"
brew "dust"
brew "duf"
brew "procs"
brew "zoxide"
brew "xh"

# Fuzzy finder & prompt
brew "fzf"
brew "starship"

# Languages & runtimes
brew "python"
brew "pipx"
brew "go"
brew "rustup"
brew "fnm"
brew "bun"

# Terminal & fonts
cask "wezterm"
cask "font-jetbrains-mono-nerd-font"
brew "tmux"
brew "neovim"
brew "git"
brew "lazygit"
brew "delta"
brew "gh"
brew "just"
brew "direnv"

# Cloud/Platform CLIs
brew "supabase"
brew "stripe"
brew "railway"

# Secrets management
cask "1password"
brew "doppler"

# Utilities
brew "curl"
brew "rsync"
brew "mosh"
brew "jq"
brew "yq"
brew "tldr"
brew "chezmoi"
EOF

# npm global packages
echo "Installing npm global packages..."
command -v vercel &> /dev/null || npm install -g vercel

# Claude Code
echo "Installing Claude Code..."
command -v claude &> /dev/null || curl -fsSL https://claude.ai/install.sh | sh

{{ else if eq .chezmoi.os "linux" -}}
# Arch Linux - pacman
{{ if lookPath "pacman" -}}
sudo pacman -S --needed --noconfirm \
    eza \
    bat \
    fd \
    ripgrep \
    sd \
    btop \
    dust \
    duf \
    procs \
    zoxide \
    xh \
    fzf \
    starship \
    python \
    python-pip \
    python-pipx \
    go \
    rustup \
    bun \
    tmux \
    neovim \
    git \
    lazygit \
    git-delta \
    github-cli \
    just \
    direnv \
    curl \
    rsync \
    mosh \
    jq \
    yq \
    tldr \
    chezmoi \
    base-devel \
    ttf-jetbrains-mono-nerd

# AUR helper (install paru if missing)
if command -v paru &> /dev/null; then
    AUR_HELPER="paru"
elif command -v yay &> /dev/null; then
    AUR_HELPER="yay"
else
    echo "Installing paru (AUR helper)..."
    sudo pacman -S --needed --noconfirm git base-devel
    tmpdir=$(mktemp -d)
    git clone https://aur.archlinux.org/paru-bin.git "$tmpdir/paru-bin"
    cd "$tmpdir/paru-bin" && makepkg -si --noconfirm
    cd - > /dev/null
    rm -rf "$tmpdir"
    AUR_HELPER="paru"
fi

if [ -n "$AUR_HELPER" ]; then
    $AUR_HELPER -S --needed --noconfirm \
        fnm \
        wezterm-git \
        supabase-bin \
        stripe-cli-bin \
        railwayapp-cli \
        1password \
        doppler-cli-bin
fi

# npm global packages
echo "Installing npm global packages..."
command -v vercel &> /dev/null || npm install -g vercel

# Claude Code
echo "Installing Claude Code..."
command -v claude &> /dev/null || curl -fsSL https://claude.ai/install.sh | sh

{{ end -}}
{{ end -}}

echo "Packages installed!"
